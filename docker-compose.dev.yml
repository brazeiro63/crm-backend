version: "3.7"

services:
  crm-backend-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: crm-backend:dev
    
    environment:
      - DATABASE_URL=postgresql://postgres:23346248c123fb599bf0b98cd5578dfb@postgres:5432/crm?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=dev-secret-key-change-me
      - JWT_EXPIRES_IN=7d
      - NODE_ENV=development
      - PORT=3001
      - FRONTEND_URL=http://localhost:3000
      - STAYS_API_URL=${STAYS_API_URL}
      - STAYS_API_KEY=${STAYS_API_KEY}

    networks:
      - CDMNet

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.crm-backend-dev.rule=Host(`api-crm-dev.casasdemargarida.com.br`)"
        - "traefik.http.routers.crm-backend-dev.entrypoints=websecure"
        - "traefik.http.routers.crm-backend-dev.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.crm-backend-dev.loadbalancer.server.port=3001"

networks:
  CDMNet:
    external: true
    name: CDMNet
