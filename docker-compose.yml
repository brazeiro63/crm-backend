version: "3.7"

services:
  crm-backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: crm-backend:latest
    
    environment:
      - DATABASE_URL=postgresql://postgres:23346248c123fb599bf0b98cd5578dfb@postgres:5432/crm?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=7d
      - NODE_ENV=production
      - PORT=3001
      - FRONTEND_URL_PROD=https://contratos.casasdemargarida.com.br
      - STAYS_API_URL=${STAYS_API_URL}
      - STAYS_LOGIN_FILE=/run/secrets/stays_login
      - STAYS_PASSWORD_FILE=/run/secrets/stays_password

    secrets:
      - stays_login
      - stays_password

    networks:
      - CDMNet

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 512M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.crm-backend.rule=Host(`api-crm.casasdemargarida.com.br`)"
        - "traefik.http.routers.crm-backend.entrypoints=websecure"
        - "traefik.http.routers.crm-backend.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.crm-backend.loadbalancer.server.port=3001"

networks:
  CDMNet:
    external: true
    name: CDMNet

secrets:
  stays_login:
    external: true
  stays_password:
    external: true
